// کوپن ها 
function display_active_coupons()
{
  if (! class_exists('WC_Coupon')) {
    return 'ووکامرس فعال نیست.';
  }

  $args = array(
    'posts_per_page' => -1,
    'post_type'      => 'shop_coupon',
    'post_status'    => 'publish',
  );

  $coupons = get_posts($args);

  if (empty($coupons)) {
    return '<p>کوپنی یافت نشد.</p>';
  }

  ob_start();
?>

  <div class="coupons-list">
    <?php
    foreach ($coupons as $coupon_post) {
      $coupon = new WC_Coupon($coupon_post->post_title);

      $expiry_date = $coupon->get_date_expires();
      if ($expiry_date && $expiry_date->getTimestamp() < time()) {
        continue;
      }

      $code = $coupon->get_code();
      $amount = $coupon->get_amount();
      $discount_type = $coupon->get_discount_type();
      $minimum_amount = $coupon->get_minimum_amount();

      switch ($discount_type) {
        case 'percent':
          $discount_text = $amount . '% تخفیف';
          break;
        case 'fixed_cart':
          $discount_text = wc_price($amount) . ' تخفیف کل سفارش';
          break;
        case 'fixed_product':
          $discount_text = wc_price($amount) . ' تخفیف محصول';
          break;
        default:
          $discount_text = '';
      }

      $condition_text = '';
      if ($minimum_amount) {
        $condition_text = ' برای سفارش بالای ' . wc_price($minimum_amount);
      }

      if ($expiry_date) {
        $expires_timestamp = $expiry_date->getTimestamp() + 86399;
      } else {
        $expires_timestamp = null;
      }
    ?>
      <div class="coupon-item">
        <h3>کد: <strong><?php echo esc_html($code); ?></strong></h3>
        <p class="discount-text"><?php echo $discount_text . $condition_text; ?></p>
        <button class="copy-btn" onclick="copyCoupon('<?php echo esc_js($code); ?>')">کپی کد</button>
        <?php if ($expires_timestamp): ?>
          <div class="countdown-timer" data-expire="<?php echo esc_attr($expires_timestamp); ?>">در حال بارگذاری...</div>
        <?php endif; ?>
      </div>
    <?php
    }
    ?>
  </div>

  <script>
    function copyCoupon(code) {
      navigator.clipboard.writeText(code).then(() => {
        alert('کد کوپن کپی شد: ' + code);
      }).catch(() => {
        alert('مشکلی در کپی کردن کد رخ داد');
      });
    }

    document.addEventListener("DOMContentLoaded", function() {
      const timers = document.querySelectorAll('.countdown-timer');

      timers.forEach(timer => {
        const expireTime = parseInt(timer.dataset.expire) * 1000;

        function updateCountdown() {
          const now = new Date().getTime();
          const diff = expireTime - now;

          if (diff < 0) {
            timer.innerHTML = '⛔ این کوپن منقضی شده';
            timer.style.color = '#c0392b';
            return;
          }

          // حذف نمایش روز
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const seconds = Math.floor((diff % (1000 * 60)) / 1000);

          let output = '🕒 باقی‌مانده: ';
          output += `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          timer.innerHTML = output;
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
      });
    });
  </script>
<?php
  return ob_get_clean();
}
add_shortcode('show_coupons', 'display_active_coupons');
